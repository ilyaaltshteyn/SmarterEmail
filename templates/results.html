<!doctype html>
<title>Send javascript with template demo</title>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Questrial|Cutive%20Mono">
</head>

<script src="http://code.jquery.com/jquery-latest.js"></script>

<style>
/*THIS IS HERE FOR NOW TO AVOID HAVING TO USE
STREAM_WITH_CONTEXT WHEN RENDERING THIS TEMPLATE*/

#data {
  text-align: center;
}

p {
    font-size: 1.05em;
    line-height: 1.421em;
    /*color: rgba(51, 51, 51, 0.80);*/
    /*color: #FCFFF5;*/
    margin: 1.421em 0px;
    font-family: "Cutive Mono";
    font-weight: 200;
    font-style: normal;
    text-align: center;
    text-rendering: geometricPrecision;
}

.loader {
  border: 16px solid #f3f3f3; /* Light grey */
  border-top: 16px solid #FA8182; /* Dark blue */
  border-radius: 50%;
  width: 120px;
  height: 120px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


</style>

<div class = "loader"></div>
<div id="data"><p>Loading... This may take a while, up to 1 minute.</p></div>

{% for i in data: %}
<script>

  function prepData(encodedString) {
    // Decodes a string encoded as htmlspecialchars, which our data is.
    var textArea = document.createElement('textarea');
    textArea.innerHTML = encodedString;
    return JSON.parse(textArea.value);
   }

  function lazyPrep(crazyString) {
    // The substring u&#39 happens bc a utf-8 encoded string gets encoded as html
    return JSON.parse(crazyString.replace('u&#39', '"'));
  }

  $(".loader").hide();
  var a = prepData("{{ i[0] }}");
  var b = lazyPrep("{{ i[1] }}");

  function makeOrdinal(floatingPoint) {
    var i = Math.round(floatingPoint);

    var j = i % 10,
        k = i % 100;
    if (j == 1 && k != 11) {
        return i + "st";
    }
    if (j == 2 && k != 12) {
        return i + "nd";
    }
    if (j == 3 && k != 13) {
        return i + "rd";
    }
    return i + "th";
  };

  $("#data").html("<p>Average reading level of your emails: " +
                  makeOrdinal(a['my_combined_grade_lvl_mean']) +
                  " grade.<br><br>Avg email length in sentences: " +
                  Math.round(a['sentence_count_mean']*10)/10 +
                  "<br><br>More metrics + complete page content coming soon.</p>");

</script>
{% endfor %}

<div id = 'sentCountsHist'></div>

<script>
// This script plots the sentence counts histogram in the sentCountsHist div

var binsDict = {'1 - 2 sentences' : 0, '3 - 5 sentences' : 0,
                '6 - 10 sentences' : 0, '11+ sentences' : 0};

var values = a['sentence_counts'];

// Build counts for histogram:
for (i = 0; i < values.length; i++){
  var v = values[i];
  if (v <= 2) { binsDict['1 - 2 sentences']++; }
  else if (v > 2 && v <= 5) { binsDict['3 - 5 sentences']++; }
  else if (v > 5 && v <= 10) { binsDict['6 - 10 sentences']++; }
  else { binsDict['11+ sentences']++; }
};

var data = [{
  x: ['1 - 2', '3 - 5', '6 - 10', '11+'],
  y: [binsDict['1 - 2 sentences'], binsDict['3 - 5 sentences'],
      binsDict['6 - 10 sentences'], binsDict['11+ sentences']],
  marker:{
    color: ['rgba(249,93,95,1)', 'rgba(250,129,130,1)', 'rgba(251,161,162,1)', 'rgba(65,65,65,1)']
  },
  type: 'bar'
}];

var layout = {
  yaxis: {showgrid: false, title: "Number of emails"},
  xaxis: {showgrid: false, title: "Sentences"},
  title: 'Email Body Length in Sentences',
  hovermode: !1,
  font: {
    size: 14,
    color: 'rgba(51,51,51,0.8)',
    family: "Questrial"
  }
};

Plotly.newPlot('sentCountsHist', data, layout, {displayModeBar: false});

</script>
